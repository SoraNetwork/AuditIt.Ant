import{u as V}from"./warehouseStore-Bf_zpT5G.js";import{u as O}from"./itemStore-DWekEsjW.js";import{u as U}from"./auditLogStore-C-CwEIJC.js";import{d as W,L as j,R,r as m,o as E,e as A,c as e,n as T,g as n,f as a,F as q,v as z,y as G,m as u,x as c,p as H,i as p,k}from"./index-D9XwG3Jh.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const K={class:"page-container"},P=W({__name:"CheckAnalysis",setup(Q){const S=V(),f=O(),x=U(),l=j({warehouseId:void 0,dateRange:[R().subtract(1,"day"),R()]}),d=m(!1),v=m(!1),g=m([]),i=m([]);E(()=>{S.fetchWarehouses()});const h=async()=>{if(!l.warehouseId){p.error("请先选择一个仓库");return}d.value=!0,g.value=[],i.value=[];try{await f.fetchItems({warehouseId:l.warehouseId});const r=f.items;await x.fetchLogs();const o=l.dateRange[0].startOf("day").toDate(),y=l.dateRange[1].endOf("day").toDate(),_=new Set(x.logs.filter(s=>s.action==="Check"&&s.warehouseId===l.warehouseId&&new Date(s.timestamp)>=o&&new Date(s.timestamp)<=y).map(s=>s.itemId));g.value=r.filter(s=>_.has(s.id)),i.value=r.filter(s=>!_.has(s.id))}catch(r){p.error("分析失败: "+r)}finally{d.value=!1}},B=async()=>{v.value=!0;try{const r=i.value.map(o=>o.id);await f.updateStatusBatch(r,"SuspectedMissing"),p.success("成功标记为疑似丢失"),h()}catch(r){p.error("标记失败: "+r)}finally{v.value=!1}};return(r,o)=>{const y=n("a-page-header"),_=n("a-select-option"),s=n("a-select"),I=n("a-form-item"),M=n("a-range-picker"),C=n("a-button"),F=n("a-form"),w=n("a-card"),D=n("a-list-item"),b=n("a-list"),L=n("a-col"),N=n("a-row");return k(),A("div",null,[e(y,{title:"盘点分析","sub-title":"查看盘点差异并处理"}),T("div",K,[e(w,null,{default:a(()=>[e(F,{layout:"inline",model:l,onFinish:h},{default:a(()=>[e(I,{label:"选择仓库"},{default:a(()=>[e(s,{value:l.warehouseId,"onUpdate:value":o[0]||(o[0]=t=>l.warehouseId=t),placeholder:"请选择仓库",style:{width:"200px"},"allow-clear":""},{default:a(()=>[(k(!0),A(q,null,z(H(S).warehouses,t=>(k(),G(_,{key:t.id,value:t.id},{default:a(()=>[u(c(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(I,{label:"盘点日期范围"},{default:a(()=>[e(M,{value:l.dateRange,"onUpdate:value":o[1]||(o[1]=t=>l.dateRange=t)},null,8,["value"])]),_:1}),e(I,null,{default:a(()=>[e(C,{type:"primary",onClick:h,loading:d.value},{default:a(()=>o[2]||(o[2]=[u("开始分析",-1)])),_:1,__:[2]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(N,{gutter:16,style:{"margin-top":"16px"}},{default:a(()=>[e(L,{span:12},{default:a(()=>[e(w,{title:"已盘点物品"},{default:a(()=>[e(b,{"data-source":g.value,loading:d.value},{renderItem:a(({item:t})=>[e(D,null,{default:a(()=>[u(c(t.itemDefinition?.name)+" ("+c(t.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1}),e(L,{span:12},{default:a(()=>[e(w,{title:"疑似丢失物品"},{extra:a(()=>[e(C,{type:"primary",danger:"",disabled:i.value.length===0,onClick:B,loading:v.value},{default:a(()=>o[3]||(o[3]=[u(" 标记为疑似丢失 ",-1)])),_:1,__:[3]},8,["disabled","loading"])]),default:a(()=>[e(b,{"data-source":i.value,loading:d.value},{renderItem:a(({item:t})=>[e(D,null,{default:a(()=>[u(c(t.itemDefinition?.name)+" ("+c(t.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1})]),_:1})])])}}}),ae=J(P,[["__scopeId","data-v-8ef747ce"]]);export{ae as default};
