import{u as N}from"./warehouseStore-Dm09vxXX.js";import{u as T}from"./itemStore-YcVsSxzb.js";import{u as W}from"./auditLogStore-CfjAiWUe.js";import{d as E,L as q,V as A,r as c,o as z,w as G,e as B,c as e,n as H,g as s,f as a,F as J,v as K,y as P,m as i,x as _,p as Q,i as m,k as b}from"./index-gKLHbOSj.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Y={class:"page-container"},Z=E({__name:"CheckAnalysis",setup($){const S=N(),h=T(),x=W(),r=q({warehouseId:void 0,dateRange:[A().subtract(1,"day"),A()]}),u=c(!1),g=c(!1),p=c([]),f=c([]),d=c({});z(()=>{S.fetchWarehouses()}),G(()=>r.warehouseId,()=>{p.value=[],f.value=[],d.value={}});const I=async()=>{if(!r.warehouseId){m.error("请先选择一个仓库");return}u.value=!0,p.value=[],f.value=[],d.value={};try{await h.fetchItems({warehouseId:r.warehouseId,status:"InStock"});const l=h.items;await x.fetchLogs();const o=r.dateRange[0].startOf("day").toDate(),k=r.dateRange[1].endOf("day").toDate(),v=new Set(x.logs.filter(n=>n.action==="Check"&&n.warehouseId===r.warehouseId&&new Date(n.timestamp)>=o&&new Date(n.timestamp)<=k).map(n=>n.itemId));p.value=l.filter(n=>v.has(n.id)),f.value=l.filter(n=>!v.has(n.id))}catch(l){m.error("分析失败: "+(l.message||l))}finally{u.value=!1}},M=async()=>{const l=Object.entries(d.value).filter(([,o])=>o).map(([o])=>o);if(l.length===0){m.warn("请至少选择一个物品");return}g.value=!0;try{await h.updateStatusBatch(l,"SuspectedMissing"),m.success("成功标记为疑似丢失"),await I()}catch(o){m.error("标记失败: "+(o.message||o))}finally{g.value=!1}};return(l,o)=>{const k=s("a-page-header"),v=s("a-select-option"),n=s("a-select"),w=s("a-form-item"),O=s("a-range-picker"),D=s("a-button"),U=s("a-form"),y=s("a-card"),C=s("a-list-item"),L=s("a-list"),R=s("a-col"),V=s("a-checkbox"),j=s("a-row");return b(),B("div",null,[e(k,{title:"盘点分析","sub-title":"查看盘点差异并处理"}),H("div",Y,[e(y,null,{default:a(()=>[e(U,{layout:"inline",model:r,onFinish:I},{default:a(()=>[e(w,{label:"选择仓库"},{default:a(()=>[e(n,{value:r.warehouseId,"onUpdate:value":o[0]||(o[0]=t=>r.warehouseId=t),placeholder:"请选择仓库",style:{width:"200px"},"allow-clear":""},{default:a(()=>[(b(!0),B(J,null,K(Q(S).warehouses,t=>(b(),P(v,{key:t.id,value:t.id},{default:a(()=>[i(_(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(w,{label:"盘点日期范围"},{default:a(()=>[e(O,{value:r.dateRange,"onUpdate:value":o[1]||(o[1]=t=>r.dateRange=t)},null,8,["value"])]),_:1}),e(w,null,{default:a(()=>[e(D,{type:"primary",onClick:I,loading:u.value},{default:a(()=>o[2]||(o[2]=[i("开始分析",-1)])),_:1,__:[2]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(j,{gutter:16,style:{"margin-top":"16px"}},{default:a(()=>[e(R,{span:12},{default:a(()=>[e(y,{title:"已盘点物品"},{default:a(()=>[e(L,{"data-source":p.value,loading:u.value,bordered:!0},{renderItem:a(({item:t})=>[e(C,null,{default:a(()=>[i(_(t.itemDefinition?.name)+" ("+_(t.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1}),e(R,{span:12},{default:a(()=>[e(y,{title:"未盘点物品 (疑似丢失)"},{extra:a(()=>[e(D,{type:"primary",danger:"",disabled:Object.values(d.value).every(t=>!t),onClick:M,loading:g.value},{default:a(()=>o[3]||(o[3]=[i(" 标记选中为丢失 ",-1)])),_:1,__:[3]},8,["disabled","loading"])]),default:a(()=>[e(L,{"data-source":f.value,loading:u.value,bordered:!0},{renderItem:a(({item:t})=>[e(C,null,{default:a(()=>[e(V,{value:t.id,checked:d.value[t.id],"onUpdate:checked":F=>d.value[t.id]=F},{default:a(()=>[i(_(t.itemDefinition?.name)+" ("+_(t.shortId)+") ",1)]),_:2},1032,["value","checked","onUpdate:checked"])]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1})]),_:1})])])}}}),ne=X(Z,[["__scopeId","data-v-d45bf5c4"]]);export{ne as default};
