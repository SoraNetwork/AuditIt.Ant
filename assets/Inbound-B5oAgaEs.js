import{u as se}from"./itemDefinitionStore-Co7NJZPD.js";import{u as ue}from"./warehouseStore-BMlJEust.js";import{c as t,I as de,d as pe,r as v,J as V,H as me,o as fe,b as x,k as T,e as s,w as a,l as w,j as y,v as ce,i as L,F as he,n as $,g as k,K as ve,h as C}from"./index-CBECFl9m.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";var be={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"};function z(f){for(var u=1;u<arguments.length;u++){var d=arguments[u]!=null?Object(arguments[u]):{},c=Object.keys(d);typeof Object.getOwnPropertySymbols=="function"&&(c=c.concat(Object.getOwnPropertySymbols(d).filter(function(h){return Object.getOwnPropertyDescriptor(d,h).enumerable}))),c.forEach(function(h){Ie(f,h,d[h])})}return f}function Ie(f,u,d){return u in f?Object.defineProperty(f,u,{value:d,enumerable:!0,configurable:!0,writable:!0}):f[u]=d,f}var q=function(u,d){var c=z({},u,d.attrs);return t(de,z({},c,{icon:be}),null)};q.displayName="UploadOutlined";q.inheritAttrs=!1;const we={class:"page-container"},ye=["src"],ke=pe({__name:"Inbound",setup(f){const u=se(),d=ue(),c=ve(),h=v("quick"),_=v(!1),O=v(),r=V({itemDefinitionId:null,warehouseId:null,quantity:1,remarks:"",photo:null}),g=v([]),H={itemDefinitionId:[{required:!0,message:"请选择物品定义"}],warehouseId:[{required:!0,message:"请选择仓库"}],quantity:[{required:!0,message:"请输入数量",type:"number",min:1}]},M=l=>{l.fileList.length>0?(g.value=[l.fileList[l.fileList.length-1]],r.photo=l.file.originFileObj):(g.value=[],r.photo=null)},Q=()=>{O.value?.resetFields(),r.remarks="",r.photo=null,g.value=[]},A=async()=>{try{await O.value?.validate(),_.value=!0;const l=r.quantity;for(let e=0;e<l;e++){const i=new FormData;i.append("itemDefinitionId",r.itemDefinitionId),i.append("warehouseId",r.warehouseId),r.remarks&&i.append("remarks",r.remarks),r.photo&&e===0&&i.append("photo",r.photo),await $.post("/items/create",i,{headers:{"Content-Type":"multipart/form-data"}})}k.success(`${l}个物品已成功入库!`),Q()}catch(l){k.error("入库操作失败，请检查表单。"),console.error(l)}finally{_.value=!1}},n=V({shortId:"",itemDefinitionId:null,warehouseId:null,remarks:"",photo:null}),D=v([]),m=v([]),F=v(!1),E=me(()=>n.shortId&&n.itemDefinitionId&&n.warehouseId),K=l=>{l.fileList.length>0?(D.value=[l.fileList[l.fileList.length-1]],n.photo=l.file.originFileObj):(D.value=[],n.photo=null)},W=()=>{n.shortId="",n.itemDefinitionId=null,n.warehouseId=null,n.remarks="",n.photo=null,D.value=[]},J=()=>{const l=u.itemDefinitions.find(i=>i.id===n.itemDefinitionId),e=d.warehouses.find(i=>i.id===n.warehouseId);m.value.push({tempId:Date.now(),shortId:n.shortId,itemDefinitionId:n.itemDefinitionId,warehouseId:n.warehouseId,remarks:n.remarks,photo:n.photo,photoPreview:n.photo?URL.createObjectURL(n.photo):null,definitionName:l?.name,warehouseName:e?.name}),W(),F.value=!1},G=l=>{const e=m.value[l];e.photoPreview&&URL.revokeObjectURL(e.photoPreview),m.value.splice(l,1)},X=async()=>{_.value=!0;const l=[];try{for(const e of m.value){if(e.id){l.push(e);continue}const i=new FormData;i.append("shortId",e.shortId),i.append("itemDefinitionId",e.itemDefinitionId),i.append("warehouseId",e.warehouseId),e.remarks&&i.append("remarks",e.remarks),e.photo&&i.append("photo",e.photo);const b=await $.post("/items/create",i,{headers:{"Content-Type":"multipart/form-data"}});l.push(b.data)}k.success(`${m.value.length}个物品已成功保存!`),m.value=l,F.value=!0}catch(e){k.error("保存过程中发生错误，部分物品可能未保存成功。"),console.error(e)}finally{_.value=!1}},Y=()=>{const l=m.value.map(i=>i.id);if(l.some(i=>!i)){k.error("列表中包含未保存的物品，请先保存再打印。");return}const e=c.resolve({name:"print-preview",query:{ids:l.join(",")}});window.open(e.href,"_blank")},Z=[{title:"外部条码",dataIndex:"shortId",key:"shortId"},{title:"物品定义",dataIndex:"definitionName",key:"definitionName"},{title:"仓库",dataIndex:"warehouseName",key:"warehouseName"},{title:"备注",dataIndex:"remarks",key:"remarks"},{title:"照片",key:"photo",width:80},{title:"操作",key:"action",width:80}];return fe(()=>{u.fetchItemDefinitions(),d.fetchWarehouses()}),(l,e)=>{const i=s("a-page-header"),b=s("a-select"),p=s("a-form-item"),ee=s("a-input-number"),S=s("a-textarea"),I=s("a-button"),P=s("a-upload"),j=s("a-form"),U=s("a-card"),B=s("a-tab-pane"),te=s("a-input"),N=s("a-col"),ae=s("a-space"),oe=s("a-popconfirm"),ne=s("a-table"),le=s("a-row"),ie=s("a-tabs");return C(),x("div",null,[t(i,{title:"入库","sub-title":"执行快速入库或批量入库操作"}),T("div",we,[t(ie,{activeKey:h.value,"onUpdate:activeKey":e[8]||(e[8]=o=>h.value=o)},{default:a(()=>[t(B,{key:"quick",tab:"快速入库"},{default:a(()=>[t(U,{title:"无外部条码入库"},{default:a(()=>[t(j,{ref_key:"quickFormRef",ref:O,model:r,rules:H,layout:"vertical",style:{"max-width":"500px",margin:"auto"}},{default:a(()=>[t(p,{label:"物品定义",name:"itemDefinitionId"},{default:a(()=>[t(b,{value:r.itemDefinitionId,"onUpdate:value":e[0]||(e[0]=o=>r.itemDefinitionId=o),"show-search":"",placeholder:"搜索或选择物品定义",options:w(u).itemDefinitions.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),t(p,{label:"存放仓库",name:"warehouseId"},{default:a(()=>[t(b,{value:r.warehouseId,"onUpdate:value":e[1]||(e[1]=o=>r.warehouseId=o),placeholder:"选择仓库",options:w(d).warehouses.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),t(p,{label:"数量",name:"quantity"},{default:a(()=>[t(ee,{value:r.quantity,"onUpdate:value":e[2]||(e[2]=o=>r.quantity=o),min:1,style:{width:"100%"}},null,8,["value"])]),_:1}),t(p,{label:"备注"},{default:a(()=>[t(S,{value:r.remarks,"onUpdate:value":e[3]||(e[3]=o=>r.remarks=o)},null,8,["value"])]),_:1}),t(p,{label:"照片"},{default:a(()=>[t(P,{"file-list":g.value,"before-upload":()=>!1,onChange:M},{default:a(()=>[t(I,null,{default:a(()=>[t(w(q)),e[9]||(e[9]=y(" 选择文件",-1))]),_:1,__:[9]})]),_:1},8,["file-list"])]),_:1}),t(p,null,{default:a(()=>[t(I,{type:"primary",onClick:A,loading:_.value},{default:a(()=>e[10]||(e[10]=[y("确认入库",-1)])),_:1,__:[10]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),t(B,{key:"batch",tab:"批量入库 (带条码)"},{default:a(()=>[t(le,{gutter:16},{default:a(()=>[t(N,{span:8},{default:a(()=>[t(U,{title:"录入新物品"},{default:a(()=>[t(j,{model:n,layout:"vertical"},{default:a(()=>[t(p,{label:"外部条码 (ShortId)"},{default:a(()=>[t(te,{value:n.shortId,"onUpdate:value":e[4]||(e[4]=o=>n.shortId=o),placeholder:"扫描或输入外部条码"},null,8,["value"])]),_:1}),t(p,{label:"物品定义"},{default:a(()=>[t(b,{value:n.itemDefinitionId,"onUpdate:value":e[5]||(e[5]=o=>n.itemDefinitionId=o),"show-search":"",placeholder:"搜索物品定义",options:w(u).itemDefinitions.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),t(p,{label:"存放仓库"},{default:a(()=>[t(b,{value:n.warehouseId,"onUpdate:value":e[6]||(e[6]=o=>n.warehouseId=o),placeholder:"选择仓库",options:w(d).warehouses.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),t(p,{label:"备注"},{default:a(()=>[t(S,{value:n.remarks,"onUpdate:value":e[7]||(e[7]=o=>n.remarks=o)},null,8,["value"])]),_:1}),t(p,{label:"照片"},{default:a(()=>[t(P,{"file-list":D.value,"before-upload":()=>!1,onChange:K},{default:a(()=>[t(I,null,{default:a(()=>[t(w(q)),e[11]||(e[11]=y(" 选择文件",-1))]),_:1,__:[11]})]),_:1},8,["file-list"])]),_:1}),t(p,null,{default:a(()=>[t(I,{type:"primary",onClick:J,disabled:!E.value},{default:a(()=>e[12]||(e[12]=[y("添加到待入库列表",-1)])),_:1,__:[12]},8,["disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),t(N,{span:16},{default:a(()=>[t(U,{title:"待入库列表"},{extra:a(()=>[t(ae,null,{default:a(()=>[t(I,{onClick:Y,disabled:!m.value.length||!F.value},{default:a(()=>e[13]||(e[13]=[y("打开打印预览",-1)])),_:1,__:[13]},8,["disabled"]),t(I,{type:"primary",onClick:X,loading:_.value,disabled:!m.value.length||F.value},{default:a(()=>e[14]||(e[14]=[y(" 保存全部 ",-1)])),_:1,__:[14]},8,["loading","disabled"])]),_:1})]),default:a(()=>[t(ne,{"data-source":m.value,columns:Z,"row-key":"tempId",size:"small"},{bodyCell:a(({column:o,record:R,index:re})=>[o.key==="action"?(C(),ce(oe,{key:0,title:"确定要移除吗?",onConfirm:ge=>G(re)},{default:a(()=>e[15]||(e[15]=[T("a",{style:{color:"red"}},"移除",-1)])),_:2,__:[15]},1032,["onConfirm"])):L("",!0),o.key==="photo"?(C(),x(he,{key:1},[R.photoPreview?(C(),x("img",{key:0,src:R.photoPreview,alt:"preview",style:{width:"50px",height:"50px","object-fit":"cover"}},null,8,ye)):L("",!0)],64)):L("",!0)]),_:1},8,["data-source"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["activeKey"])])])}}}),Oe=_e(ke,[["__scopeId","data-v-30b16a63"]]);export{Oe as default};
