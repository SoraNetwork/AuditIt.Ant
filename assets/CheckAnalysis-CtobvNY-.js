import{u as N}from"./warehouseStore-CHfZT3Dy.js";import{u as H}from"./itemStore-Cw6h60aM.js";import{u as O}from"./auditLogStore-XiHtLpAg.js";import{d as T,L as W,V as L,r as i,o as E,w as q,e as A,c as e,n as z,g as n,f as a,F as G,v as J,y as K,m as _,x as m,p as P,i as u,k as b}from"./index-Be_Z_p8Z.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const X={class:"page-container"},Z=T({__name:"CheckAnalysis",setup($){const S=N(),h=H(),D=O(),s=W({warehouseId:void 0,dateRange:[L().subtract(1,"day"),L()]}),c=i(!1),g=i(!1),p=i([]),f=i([]),d=i({});E(()=>{S.fetchWarehouses()}),q(()=>s.warehouseId,()=>{p.value=[],f.value=[],d.value={}});const I=async()=>{if(!s.warehouseId){u.error("请先选择一个仓库");return}if(!s.dateRange||s.dateRange.length!==2){u.error("请选择完整的时间范围");return}c.value=!0,p.value=[],f.value=[],d.value={};try{await h.fetchItems({warehouseId:s.warehouseId,status:"InStock"});const l=h.items;await D.fetchLogs();const o=s.dateRange[0].subtract(8,"hour").toDate(),k=s.dateRange[1].subtract(8,"hour").toDate(),v=new Set(D.logs.filter(r=>r.action==="Check"&&r.warehouseId===s.warehouseId&&new Date(r.timestamp)>=o&&new Date(r.timestamp)<=k).map(r=>r.itemId));p.value=l.filter(r=>v.has(r.id)),f.value=l.filter(r=>!v.has(r.id))}catch(l){u.error("分析失败: "+(l.message||l))}finally{c.value=!1}},B=async()=>{const l=Object.entries(d.value).filter(([,o])=>o).map(([o])=>o);if(l.length===0){u.warn("请至少选择一个物品");return}g.value=!0;try{await h.updateStatusBatch(l,"SuspectedMissing"),u.success("成功标记为疑似丢失"),await I()}catch(o){u.error("标记失败: "+(o.message||o))}finally{g.value=!1}};return(l,o)=>{const k=n("a-page-header"),v=n("a-select-option"),r=n("a-select"),w=n("a-form-item"),U=n("a-range-picker"),x=n("a-button"),V=n("a-form"),y=n("a-card"),C=n("a-list-item"),R=n("a-list"),M=n("a-col"),Y=n("a-checkbox"),j=n("a-row");return b(),A("div",null,[e(k,{title:"盘点分析","sub-title":"查看盘点差异并处理"}),z("div",X,[e(y,null,{default:a(()=>[e(V,{layout:"inline",model:s,onFinish:I},{default:a(()=>[e(w,{label:"选择仓库"},{default:a(()=>[e(r,{value:s.warehouseId,"onUpdate:value":o[0]||(o[0]=t=>s.warehouseId=t),placeholder:"请选择仓库",style:{width:"200px"},"allow-clear":""},{default:a(()=>[(b(!0),A(G,null,J(P(S).warehouses,t=>(b(),K(v,{key:t.id,value:t.id},{default:a(()=>[_(m(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),_:1}),e(w,{label:"盘点时间范围"},{default:a(()=>[e(U,{value:s.dateRange,"onUpdate:value":o[1]||(o[1]=t=>s.dateRange=t),"show-time":"",format:"YYYY-MM-DD HH:mm:ss",placeholder:["开始时间","结束时间"]},null,8,["value"])]),_:1}),e(w,null,{default:a(()=>[e(x,{type:"primary",onClick:I,loading:c.value},{default:a(()=>o[2]||(o[2]=[_("开始分析",-1)])),_:1,__:[2]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),e(j,{gutter:16,style:{"margin-top":"16px"}},{default:a(()=>[e(M,{span:12},{default:a(()=>[e(y,{title:"已盘点物品"},{default:a(()=>[e(R,{"data-source":p.value,loading:c.value,bordered:!0},{renderItem:a(({item:t})=>[e(C,null,{default:a(()=>[_(m(t.itemDefinition?.name)+" ("+m(t.shortId)+")",1)]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1}),e(M,{span:12},{default:a(()=>[e(y,{title:"未盘点物品 (疑似丢失)"},{extra:a(()=>[e(x,{type:"primary",danger:"",disabled:Object.values(d.value).every(t=>!t),onClick:B,loading:g.value},{default:a(()=>o[3]||(o[3]=[_(" 标记选中为丢失 ",-1)])),_:1,__:[3]},8,["disabled","loading"])]),default:a(()=>[e(R,{"data-source":f.value,loading:c.value,bordered:!0},{renderItem:a(({item:t})=>[e(C,null,{default:a(()=>[e(Y,{value:t.id,checked:d.value[t.id],"onUpdate:checked":F=>d.value[t.id]=F},{default:a(()=>[_(m(t.itemDefinition?.name)+" ("+m(t.shortId)+") ",1)]),_:2},1032,["value","checked","onUpdate:checked"])]),_:2},1024)]),_:1},8,["data-source","loading"])]),_:1})]),_:1})]),_:1})])])}}}),ne=Q(Z,[["__scopeId","data-v-edbac5d1"]]);export{ne as default};
