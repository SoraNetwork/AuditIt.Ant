import{u as J}from"./itemDefinitionStore-04-9rTHn.js";import{u as Q}from"./warehouseStore-B9n1r2kT.js";import{c as o,I as X,d as Y,H as Z,r as _,G as K,o as ee,b as k,k as U,w as a,e as u,l as y,j as I,q as te,i as g,F as oe,m as ae,g as D,J as ne,h as b}from"./index-DXAPKMDa.js";var le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"};function N(p){for(var i=1;i<arguments.length;i++){var s=arguments[i]!=null?Object(arguments[i]):{},c=Object.keys(s);typeof Object.getOwnPropertySymbols=="function"&&(c=c.concat(Object.getOwnPropertySymbols(s).filter(function(t){return Object.getOwnPropertyDescriptor(s,t).enumerable}))),c.forEach(function(t){re(p,t,s[t])})}return p}function re(p,i,s){return i in p?Object.defineProperty(p,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):p[i]=s,p}var C=function(i,s){var c=N({},i,s.attrs);return o(X,N({},c,{icon:le}),null)};C.displayName="UploadOutlined";C.inheritAttrs=!1;const ie=["src"],me=Y({__name:"ItemCreation",setup(p){const i=J(),s=Q(),c=ne(),t=Z({shortId:"",itemDefinitionId:null,warehouseId:null,remarks:"",photo:null}),f=_([]),d=_([]),w=_(!1),h=_(!1),j=K(()=>t.shortId&&t.itemDefinitionId&&t.warehouseId);ee(()=>{i.fetchItemDefinitions(),s.fetchWarehouses()});const L=n=>{n.fileList.length>0?(f.value=[n.fileList[n.fileList.length-1]],t.photo=n.file.originFileObj):(f.value=[],t.photo=null)},V=()=>{t.shortId="",t.itemDefinitionId=null,t.warehouseId=null,t.remarks="",t.photo=null,f.value=[]},B=()=>{const n=i.itemDefinitions.find(l=>l.id===t.itemDefinitionId),e=s.warehouses.find(l=>l.id===t.warehouseId);d.value.push({tempId:Date.now(),shortId:t.shortId,itemDefinitionId:t.itemDefinitionId,warehouseId:t.warehouseId,remarks:t.remarks,photo:t.photo,photoPreview:t.photo?URL.createObjectURL(t.photo):null,definitionName:n?.name,warehouseName:e?.name}),V(),h.value=!1},F=n=>{const e=d.value[n];e.photoPreview&&URL.revokeObjectURL(e.photoPreview),d.value.splice(n,1)},R=async()=>{w.value=!0;const n=[];try{for(const e of d.value){const l=new FormData;l.append("shortId",e.shortId),l.append("itemDefinitionId",e.itemDefinitionId),l.append("warehouseId",e.warehouseId),e.remarks&&l.append("remarks",e.remarks),e.photo&&l.append("photo",e.photo);const m=await ae.post("/items/create",l,{headers:{"Content-Type":"multipart/form-data"}});n.push(m.data)}D.success(`${d.value.length}个物品已成功保存!`),d.value=n,h.value=!0}catch(e){D.error("保存过程中发生错误，部分物品可能未保存成功。"),console.error(e)}finally{w.value=!1}},T=()=>{const n=d.value.map(l=>l.id);if(n.some(l=>!l)){D.error("列表中包含未保存的物品，请先保存再打印。");return}const e=c.resolve({name:"print-preview",query:{ids:n.join(",")}});window.open(e.href,"_blank")},z=[{title:"外部条码",dataIndex:"shortId",key:"shortId"},{title:"物品定义",dataIndex:"definitionName",key:"definitionName"},{title:"仓库",dataIndex:"warehouseName",key:"warehouseName"},{title:"备注",dataIndex:"remarks",key:"remarks"},{title:"照片",key:"photo"},{title:"操作",key:"action"}];return(n,e)=>{const l=u("a-input"),m=u("a-form-item"),O=u("a-select"),H=u("a-textarea"),v=u("a-button"),M=u("a-upload"),$=u("a-form"),x=u("a-card"),P=u("a-col"),q=u("a-space"),A=u("a-popconfirm"),E=u("a-table"),W=u("a-row");return b(),k("div",null,[e[9]||(e[9]=U("h2",null,"物品批量录入",-1)),o(W,{gutter:16},{default:a(()=>[o(P,{span:8},{default:a(()=>[o(x,{title:"录入新物品"},{default:a(()=>[o($,{model:t,layout:"vertical"},{default:a(()=>[o(m,{label:"外部条码 (ShortId)"},{default:a(()=>[o(l,{value:t.shortId,"onUpdate:value":e[0]||(e[0]=r=>t.shortId=r),placeholder:"扫描或输入外部条码"},null,8,["value"])]),_:1}),o(m,{label:"物品定义"},{default:a(()=>[o(O,{value:t.itemDefinitionId,"onUpdate:value":e[1]||(e[1]=r=>t.itemDefinitionId=r),"show-search":"",placeholder:"搜索物品定义",options:y(i).itemDefinitions.map(r=>({value:r.id,label:r.name}))},null,8,["value","options"])]),_:1}),o(m,{label:"存放仓库"},{default:a(()=>[o(O,{value:t.warehouseId,"onUpdate:value":e[2]||(e[2]=r=>t.warehouseId=r),placeholder:"选择仓库",options:y(s).warehouses.map(r=>({value:r.id,label:r.name}))},null,8,["value","options"])]),_:1}),o(m,{label:"备注"},{default:a(()=>[o(H,{value:t.remarks,"onUpdate:value":e[3]||(e[3]=r=>t.remarks=r)},null,8,["value"])]),_:1}),o(m,{label:"照片"},{default:a(()=>[o(M,{"file-list":f.value,"before-upload":()=>!1,onChange:L},{default:a(()=>[o(v,null,{default:a(()=>[o(y(C)),e[4]||(e[4]=I(" 选择文件 ",-1))]),_:1,__:[4]})]),_:1},8,["file-list"])]),_:1}),o(m,null,{default:a(()=>[o(v,{type:"primary",onClick:B,disabled:!j.value},{default:a(()=>e[5]||(e[5]=[I("添加到待录入列表",-1)])),_:1,__:[5]},8,["disabled"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),o(P,{span:16},{default:a(()=>[o(x,{title:"待录入列表"},{extra:a(()=>[o(q,null,{default:a(()=>[o(v,{onClick:T,disabled:!d.value.length||!h.value},{default:a(()=>e[6]||(e[6]=[I("打印选中项",-1)])),_:1,__:[6]},8,["disabled"]),o(v,{type:"primary",onClick:R,loading:w.value,disabled:!d.value.length||h.value},{default:a(()=>e[7]||(e[7]=[I(" 保存全部 ",-1)])),_:1,__:[7]},8,["loading","disabled"])]),_:1})]),default:a(()=>[o(E,{"data-source":d.value,columns:z,"row-key":"tempId",size:"small"},{bodyCell:a(({column:r,record:S,index:G})=>[r.key==="action"?(b(),te(A,{key:0,title:"确定要移除吗?",onConfirm:se=>F(G)},{default:a(()=>e[8]||(e[8]=[U("a",{style:{color:"red"}},"移除",-1)])),_:2,__:[8]},1032,["onConfirm"])):g("",!0),r.key==="photo"?(b(),k(oe,{key:1},[S.photoPreview?(b(),k("img",{key:0,src:S.photoPreview,alt:"preview",style:{width:"50px",height:"50px","object-fit":"cover"}},null,8,ie)):g("",!0)],64)):g("",!0)]),_:1},8,["data-source"])]),_:1})]),_:1})]),_:1})])}}});export{me as default};
