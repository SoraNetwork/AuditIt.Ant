import{u as pe}from"./itemDefinitionStore-CK4T2v9T.js";import{u as fe}from"./warehouseStore-DBWQiWPj.js";import{c as e,I as ce,d as ve,r as c,J as A,o as _e,b as P,k as Q,e as s,w as a,l as I,j as y,v as he,i as R,F as we,n as E,g as b,K as Ie,h as C}from"./index-CaKG2D3L.js";import{_ as ye}from"./ItemDefinitionForm.vue_vue_type_script_setup_true_lang-DiyQd4Jr.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./categoryStore-BK8bqt7y.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M400 317.7h73.9V656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V317.7H624c6.7 0 10.4-7.7 6.3-12.9L518.3 163a8 8 0 00-12.6 0l-112 141.7c-4.1 5.3-.4 13 6.3 13zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"upload",theme:"outlined"};function H(f){for(var u=1;u<arguments.length;u++){var d=arguments[u]!=null?Object(arguments[u]):{},h=Object.keys(d);typeof Object.getOwnPropertySymbols=="function"&&(h=h.concat(Object.getOwnPropertySymbols(d).filter(function(v){return Object.getOwnPropertyDescriptor(d,v).enumerable}))),h.forEach(function(v){ge(f,v,d[v])})}return f}function ge(f,u,d){return u in f?Object.defineProperty(f,u,{value:d,enumerable:!0,configurable:!0,writable:!0}):f[u]=d,f}var O=function(u,d){var h=H({},u,d.attrs);return e(ce,H({},h,{icon:ke}),null)};O.displayName="UploadOutlined";O.inheritAttrs=!1;const De={class:"page-container"},Fe=["src"],qe=ve({__name:"Inbound",setup(f){const u=pe(),d=fe(),h=Ie(),v=c("quick"),k=c(!1),D=c(!1),U=c(null),x=c(),i=A({shortId:"",itemDefinitionId:null,warehouseId:null,remarks:"",photo:null}),F=c([]),K={shortId:[{required:!0,message:"请输入外部条码"}],itemDefinitionId:[{required:!0,message:"请选择物品定义"}],warehouseId:[{required:!0,message:"请选择仓库"}]},W=n=>{n.fileList.length>0?(F.value=[n.fileList[n.fileList.length-1]],i.photo=n.file.originFileObj):(F.value=[],i.photo=null)},J=()=>{x.value?.resetFields(),i.remarks="",i.photo=null,F.value=[]},G=async()=>{try{await x.value?.validate(),k.value=!0;const n=new FormData;n.append("shortId",i.shortId),n.append("itemDefinitionId",String(i.itemDefinitionId)),n.append("warehouseId",String(i.warehouseId)),i.remarks&&n.append("remarks",i.remarks),i.photo&&n.append("photo",i.photo),await E.post("/items/create",n,{headers:{"Content-Type":"multipart/form-data"}}),b.success(`物品 ${i.shortId} 已成功入库!`),J()}catch(n){b.error("入库失败，请检查表单或条码是否已存在。"),console.error(n)}finally{k.value=!1}},L=c(),l=A({itemDefinitionId:null,warehouseId:null,quantity:1,remarks:"",photo:null}),q=c([]),_=c([]),X={itemDefinitionId:[{required:!0,message:"请选择物品定义"}],warehouseId:[{required:!0,message:"请选择仓库"}],quantity:[{required:!0,message:"请输入数量",type:"number",min:1}]},Y=n=>{n.fileList.length>0?(q.value=[n.fileList[n.fileList.length-1]],l.photo=n.file.originFileObj):(q.value=[],l.photo=null)},Z=()=>{L.value?.resetFields(),l.remarks="",l.photo=null,q.value=[]},ee=async()=>{try{await L.value?.validate();const n=u.itemDefinitions.find(m=>m.id===l.itemDefinitionId),t=d.warehouses.find(m=>m.id===l.warehouseId);for(let m=0;m<l.quantity;m++)_.value.push({tempId:Date.now()+m,itemDefinitionId:l.itemDefinitionId,warehouseId:l.warehouseId,remarks:l.remarks,photo:m===0?l.photo:null,photoPreview:m===0&&l.photo?URL.createObjectURL(l.photo):null,definitionName:n?.name,warehouseName:t?.name});Z()}catch{b.error("请填写所有必填项。")}},te=n=>{const t=_.value[n];t.photoPreview&&URL.revokeObjectURL(t.photoPreview),_.value.splice(n,1)},ae=async()=>{k.value=!0;const n=[];try{for(const p of _.value){const r=new FormData;r.append("itemDefinitionId",p.itemDefinitionId),r.append("warehouseId",p.warehouseId),p.remarks&&r.append("remarks",p.remarks),p.photo&&r.append("photo",p.photo);const g=await E.post("/items/create",r,{headers:{"Content-Type":"multipart/form-data"}});n.push(g.data)}b.success(`${_.value.length}个新物品已成功保存!`);const t=n.map(p=>p.id),m=h.resolve({name:"print-preview",query:{ids:t.join(",")}});window.open(m.href,"_blank"),_.value=[]}catch(t){b.error("保存过程中发生错误。"),console.error(t)}finally{k.value=!1}},oe=[{title:"物品定义",dataIndex:"definitionName",key:"definitionName"},{title:"仓库",dataIndex:"warehouseName",key:"warehouseName"},{title:"备注",dataIndex:"remarks",key:"remarks"},{title:"照片",key:"photo",width:80},{title:"操作",key:"action",width:80}],S=()=>{D.value=!0},ne=async()=>{try{const n=await U.value?.validateFields();if(!n)return;const t=await u.addItemDefinition(n);b.success("新物品定义创建成功！"),v.value==="quick"?i.itemDefinitionId=t.id:l.itemDefinitionId=t.id,D.value=!1,U.value?.resetFields()}catch{b.error("请检查表单")}};return _e(()=>{u.fetchItemDefinitions(),d.fetchWarehouses()}),(n,t)=>{const m=s("a-page-header"),p=s("a-input"),r=s("a-form-item"),g=s("a-select"),w=s("a-button"),j=s("a-space-compact"),V=s("a-textarea"),M=s("a-upload"),T=s("a-form"),N=s("a-card"),B=s("a-tab-pane"),le=s("a-input-number"),$=s("a-col"),ie=s("a-popconfirm"),re=s("a-table"),se=s("a-row"),ue=s("a-tabs"),de=s("a-modal");return C(),P("div",null,[e(m,{title:"入库","sub-title":"执行快速入库或手动生成新物品"}),Q("div",De,[e(ue,{activeKey:v.value,"onUpdate:activeKey":t[8]||(t[8]=o=>v.value=o)},{default:a(()=>[e(B,{key:"quick",tab:"快速入库 (带条码)"},{default:a(()=>[e(N,{title:"扫描或输入已有条码的物品"},{default:a(()=>[e(T,{ref_key:"quickFormRef",ref:x,model:i,rules:K,layout:"vertical",style:{"max-width":"500px",margin:"auto"}},{default:a(()=>[e(r,{label:"外部条码 (ShortId)",name:"shortId"},{default:a(()=>[e(p,{value:i.shortId,"onUpdate:value":t[0]||(t[0]=o=>i.shortId=o),placeholder:"扫描或输入外部条码"},null,8,["value"])]),_:1}),e(r,{label:"物品定义",name:"itemDefinitionId"},{default:a(()=>[e(j,{style:{width:"100%"}},{default:a(()=>[e(g,{value:i.itemDefinitionId,"onUpdate:value":t[1]||(t[1]=o=>i.itemDefinitionId=o),"show-search":"",placeholder:"搜索或选择物品定义",options:I(u).itemDefinitions.map(o=>({value:o.id,label:o.name})),style:{width:"calc(100% - 60px)"}},null,8,["value","options"]),e(w,{onClick:S},{default:a(()=>t[10]||(t[10]=[y("新建",-1)])),_:1,__:[10]})]),_:1})]),_:1}),e(r,{label:"存放仓库",name:"warehouseId"},{default:a(()=>[e(g,{value:i.warehouseId,"onUpdate:value":t[2]||(t[2]=o=>i.warehouseId=o),placeholder:"选择仓库",options:I(d).warehouses.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),e(r,{label:"备注"},{default:a(()=>[e(V,{value:i.remarks,"onUpdate:value":t[3]||(t[3]=o=>i.remarks=o)},null,8,["value"])]),_:1}),e(r,{label:"照片"},{default:a(()=>[e(M,{"file-list":F.value,"before-upload":()=>!1,onChange:W},{default:a(()=>[e(w,null,{default:a(()=>[e(I(O)),t[11]||(t[11]=y(" 选择文件",-1))]),_:1,__:[11]})]),_:1},8,["file-list"])]),_:1}),e(r,null,{default:a(()=>[e(w,{type:"primary",onClick:G,loading:k.value},{default:a(()=>t[12]||(t[12]=[y("确认入库",-1)])),_:1,__:[12]},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),e(B,{key:"manual",tab:"手动入库 (生成新条码)"},{default:a(()=>[e(se,{gutter:16},{default:a(()=>[e($,{span:8},{default:a(()=>[e(N,{title:"录入新物品信息"},{default:a(()=>[e(T,{ref_key:"manualFormRef",ref:L,model:l,rules:X,layout:"vertical"},{default:a(()=>[e(r,{label:"物品定义",name:"itemDefinitionId"},{default:a(()=>[e(j,{style:{width:"100%"}},{default:a(()=>[e(g,{value:l.itemDefinitionId,"onUpdate:value":t[4]||(t[4]=o=>l.itemDefinitionId=o),"show-search":"",placeholder:"搜索或选择物品定义",options:I(u).itemDefinitions.map(o=>({value:o.id,label:o.name})),style:{width:"calc(100% - 60px)"}},null,8,["value","options"]),e(w,{onClick:S},{default:a(()=>t[13]||(t[13]=[y("新建",-1)])),_:1,__:[13]})]),_:1})]),_:1}),e(r,{label:"存放仓库",name:"warehouseId"},{default:a(()=>[e(g,{value:l.warehouseId,"onUpdate:value":t[5]||(t[5]=o=>l.warehouseId=o),placeholder:"选择仓库",options:I(d).warehouses.map(o=>({value:o.id,label:o.name}))},null,8,["value","options"])]),_:1}),e(r,{label:"数量",name:"quantity"},{default:a(()=>[e(le,{value:l.quantity,"onUpdate:value":t[6]||(t[6]=o=>l.quantity=o),min:1,style:{width:"100%"}},null,8,["value"])]),_:1}),e(r,{label:"备注"},{default:a(()=>[e(V,{value:l.remarks,"onUpdate:value":t[7]||(t[7]=o=>l.remarks=o)},null,8,["value"])]),_:1}),e(r,{label:"照片"},{default:a(()=>[e(M,{"file-list":q.value,"before-upload":()=>!1,onChange:Y},{default:a(()=>[e(w,null,{default:a(()=>[e(I(O)),t[14]||(t[14]=y(" 选择文件",-1))]),_:1,__:[14]})]),_:1},8,["file-list"])]),_:1}),e(r,null,{default:a(()=>[e(w,{type:"primary",onClick:ee},{default:a(()=>t[15]||(t[15]=[y("添加到待打印列表",-1)])),_:1,__:[15]})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),e($,{span:16},{default:a(()=>[e(N,{title:"待打印列表"},{extra:a(()=>[e(w,{type:"primary",onClick:ae,loading:k.value,disabled:!_.value.length},{default:a(()=>t[16]||(t[16]=[y(" 全部保存并打开打印预览 ",-1)])),_:1,__:[16]},8,["loading","disabled"])]),default:a(()=>[e(re,{"data-source":_.value,columns:oe,"row-key":"tempId",size:"small"},{bodyCell:a(({column:o,record:z,index:me})=>[o.key==="action"?(C(),he(ie,{key:0,title:"确定要移除吗?",onConfirm:Ce=>te(me)},{default:a(()=>t[17]||(t[17]=[Q("a",{style:{color:"red"}},"移除",-1)])),_:2,__:[17]},1032,["onConfirm"])):R("",!0),o.key==="photo"?(C(),P(we,{key:1},[z.photoPreview?(C(),P("img",{key:0,src:z.photoPreview,alt:"preview",style:{width:"50px",height:"50px","object-fit":"cover"}},null,8,Fe)):R("",!0)],64)):R("",!0)]),_:1},8,["data-source"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["activeKey"])]),e(de,{open:D.value,"onUpdate:open":t[9]||(t[9]=o=>D.value=o),title:"新建物品定义",onOk:ne,"confirm-loading":I(u).loading},{default:a(()=>[e(ye,{ref_key:"newItemDefFormRef",ref:U},null,512)]),_:1},8,["open","confirm-loading"])])}}}),Re=be(qe,[["__scopeId","data-v-6dc28ae5"]]);export{Re as default};
